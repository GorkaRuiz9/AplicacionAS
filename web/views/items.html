<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Items - The Binding of Isaac</title>
  <link rel="stylesheet" href="/style.css">
</head>
<body>
  <header>
    <h1>The Binding of Isaac Repentance</h1>
    <nav>
      <a href="/">Inicio</a>
      <a href="/items">Items</a>
      <a href="/favoritos">Favoritos</a> <!-- Añadido -->
    </nav>
  </header>

  <main>
    <section class="intro">
      <h2>Lista de Items</h2>
      <p>Busca tus items favoritos usando la barra de búsqueda:</p>
      <input type="text" id="search-bar" placeholder="Buscar item...">
    </section>

    <section class="image-section" id="items-container">
      <!-- Los items se cargarán aquí dinámicamente -->
    </section>
  </main>

  <footer>
    <p>Hecho con ❤️ por un fan de Isaac</p>
  </footer>

  <script>
    const searchBar = document.getElementById('search-bar');
    const itemsContainer = document.getElementById('items-container');
    let allItems = [];

    function createTooltip(item) {
      const values = Object.entries(item)
        .slice(2)
        .map(([key, value]) => {
          if (value === null || value === undefined) value = '';
          return String(value).replace(/"/g, "'");
        });
      return values.join('\n');
    }

    function renderItems(items) {
      itemsContainer.innerHTML = '';
      items.forEach(item => {
        const card = document.createElement('div');
        card.className = 'item-card';

        const imageName = encodeURIComponent(item['item-title']) + '.png';
        const imagePath = `/images/items/${imageName}`;
        const img = document.createElement('img');
        img.src = imagePath;
        img.alt = item['item-title'];
        img.title = createTooltip(item);

        const title = document.createElement('p');
        title.textContent = item['item-title'];

        const favBtn = document.createElement('button');
        favBtn.textContent = '❤️ Favorito';
        favBtn.addEventListener('click', () => addToFavorites(item));

        card.appendChild(img);
        card.appendChild(title);
        card.appendChild(favBtn);

        itemsContainer.appendChild(card);
      });
    }

    async function loadItems() {
      try {
        const res = await fetch('http://localhost:8000/items'); 
        const data = await res.json();
        allItems = data;
        renderItems(allItems);
      } catch (err) {
        console.error('Error al cargar items:', err);
        itemsContainer.innerHTML = '<p>No se pudieron cargar los items.</p>';
      }
    }

    loadItems();

    searchBar.addEventListener('input', () => {
      const query = searchBar.value.toLowerCase();
      const filtered = allItems.filter(item => item['item-title'].toLowerCase().includes(query));
      renderItems(filtered);
    });

    async function addToFavorites(item) {
      try {
        const res = await fetch('http://localhost:8000/favoritos', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(item)
        });

        if (!res.ok) throw new Error('El item ya está guardado en favoritos');

        alert(`Item "${item['item-title']}" guardado en favoritos ✅`);
      } catch (err) {
        console.error(err);
        alert('El item ya está guardado en favoritos');
      }
    }
  </script>
</body>
</html>
